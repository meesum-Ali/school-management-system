import{j as s,P as Y,U as y,u as q,M as G,r as l,A as Q,N as W,O as L,Q as J,G as p,R as K,S as X,V as Z,W as $}from"./index-C8VS4fXx.js";import{C as ss}from"./ClassForm-CKqPO0iO.js";import{N as b}from"./Notification-B1yMlq7q.js";import{C as O,B as A}from"./Card-OmK6nwwd.js";import{S as es}from"./Select-DOi9PUKF.js";import"./index.esm-BWXX6-1U.js";import"./Input-BklDdty6.js";const ts=()=>{q();const{id:a}=G(),[n,m]=l.useState(void 0),[P,R]=l.useState([]),[d,E]=l.useState(""),[N,x]=l.useState(!0),[U,I]=l.useState(!1),[j,h]=l.useState(!1),[g,i]=l.useState(null),[w,c]=l.useState(null),[C,M]=l.useState([]),[f,o]=l.useState(!1),[D,u]=l.useState(null),{user:S}=l.useContext(Q),F=l.useCallback(async()=>{if(a&&typeof a=="string"&&S?.roles.includes(y.SCHOOL_ADMIN))try{x(!0),o(!0),i(null),u(null);const e=W(a),t=L(a),r=J(),[B,z,V]=await Promise.all([e,t,r]);m(B),M(z),R(V)}catch(e){const t=e instanceof Error?e.message:"Failed to load class or student data.";i(t),u(t)}finally{x(!1),o(!1)}else a&&!S?.roles.includes(y.SCHOOL_ADMIN)?(i("You don't have permission to view this class details."),x(!1),o(!1)):(x(!1),o(!1))},[a,S]);l.useEffect(()=>{F()},[F]);const k=async e=>{if(!(!a||typeof a!="string")){I(!0),i(null);try{const t=await K(a,e);m(t)}catch(t){const r=t instanceof Error?t.message:"Failed to update class.";i(r)}finally{I(!1)}}},H=async()=>{if(!a||typeof a!="string"||!d){c("Please select a subject to assign.");return}h(!0),c(null);try{const e=await Z(a,d);m(e),E("")}catch(e){const t=e instanceof Error?e.message:"Failed to assign subject.";c(t)}finally{h(!1)}},T=async e=>{if(!(!a||typeof a!="string")){h(!0),c(null);try{const t=await X(a,e);m(t)}catch(t){const r=t instanceof Error?t.message:"Failed to remove subject.";c(r)}finally{h(!1)}}},_=async e=>{if(!(!a||typeof a!="string")){o(!0),u(null);try{await $(e,null);const t=await L(a);M(t)}catch(t){const r=t instanceof Error?t.message:"Failed to unenroll student.";u(r)}finally{o(!1)}}},v=P.filter(e=>!n?.subjects?.some(t=>t.id===e.id));return!S?.roles.includes(y.SCHOOL_ADMIN)&&!N&&!f?s.jsx(p,{children:s.jsx("div",{className:"container mx-auto p-4",children:s.jsx(b,{message:g||"You do not have permission to edit classes.",type:"error"})})}):N?s.jsx(p,{children:s.jsx("div",{className:"container mx-auto p-4 text-center",children:"Loading class data..."})}):!n&&!g?s.jsx(p,{children:s.jsx("div",{className:"container mx-auto p-4 text-center",children:"Class not found."})}):s.jsx(p,{children:s.jsx("div",{className:"container mx-auto p-4 flex justify-center",children:s.jsxs("div",{className:"w-full max-w-lg",children:[g&&s.jsx(b,{message:g,type:"error",onClose:()=>i(null)}),s.jsx("h1",{className:"text-2xl font-semibold mb-6 text-center",children:"Edit Class"}),n?s.jsxs(s.Fragment,{children:[s.jsx(ss,{initialData:n,onSubmit:k,isSubmitting:U}),s.jsxs(O,{className:"mt-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Manage Subjects"}),w&&s.jsx(b,{message:w,type:"error",onClose:()=>c(null)}),s.jsxs("div",{className:"mb-4",children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"Assigned Subjects:"}),n.subjects&&n.subjects.length>0?s.jsx("ul",{className:"list-disc pl-5",children:n.subjects.map(e=>s.jsxs("li",{className:"flex justify-between items-center py-1",children:[s.jsxs("span",{children:[e.name," (",e.code,")"]}),s.jsx(A,{variant:"destructive",size:"sm",onClick:()=>T(e.id),disabled:j,children:"Remove"})]},e.id))}):s.jsx("p",{children:"No subjects assigned yet."})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"Assign New Subject:"}),s.jsxs("div",{className:"flex space-x-2",children:[s.jsxs(es,{value:d,onChange:e=>E(e.target.value),className:"flex-grow",disabled:j||v.length===0,children:[s.jsx("option",{value:"",children:"Select a subject"}),v.map(e=>s.jsxs("option",{value:e.id,children:[e.name," (",e.code,")"]},e.id))]}),s.jsx(A,{onClick:H,disabled:j||!d,children:j?"Assigning...":"Assign Subject"})]}),v.length===0&&!d&&s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"All available subjects are already assigned."})]})]}),s.jsxs(O,{className:"mt-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Enrolled Students"}),f&&s.jsx("p",{children:"Loading students..."}),D&&s.jsx(b,{message:D,type:"error",onClose:()=>u(null)}),!f&&C.length===0&&s.jsx("p",{children:"No students enrolled in this class."}),!f&&C.length>0&&s.jsx("ul",{className:"space-y-2",children:C.map(e=>s.jsxs("li",{className:"flex justify-between items-center p-2 border rounded hover:bg-gray-50",children:[s.jsxs("div",{children:[s.jsxs("p",{className:"font-medium",children:[e.firstName," ",e.lastName]}),s.jsxs("p",{className:"text-sm text-gray-600",children:["Email: ",e.email]}),s.jsxs("p",{className:"text-sm text-gray-500",children:["Student ID: ",e.studentId]})]}),s.jsx(A,{variant:"outline",size:"sm",onClick:()=>_(e.id),children:"Unenroll"})]},e.id))})]})]}):!N&&s.jsx("p",{className:"text-center text-red-500",children:"Class data could not be loaded."})]})})})},ds=()=>s.jsx(Y,{requiredRoles:[y.SCHOOL_ADMIN],children:s.jsx(ts,{})});export{ds as default};
